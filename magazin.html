<!DOCTYPE html>
<html lang="tg" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мағоза - Istanbul Fashion Tj</title>
    
    <meta name="description" content="Маҳсулоти муосири Туркӣ ва Узбекӣ дар Тоҷикистон. Интихоби васеъ аз либосҳои сифатӣ дар мағозаи онлайн.">
    <meta name="keywords" content="маҳсулот, либосҳои туркӣ, кийим, фармоиш, нарх">
    <meta property="og:title" content="Мағоза - Istanbul Fashion Tj">
    <meta property="og:description" content="Маҳсулоти муосири Туркӣ ва Узбекӣ дар Тоҷикистон.">
    <meta property="og:image" content="https://istanbulfashiontj.pythonanywhere.com/static/uploads/logo.png">
    <meta property="og:url" content="https://istanbulfashiontj.github.io/istanbul-fashion-web/magazin.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="icon" type="image/png" href="https://istanbulfashiontj.pythonanywhere.com/static/uploads/logo.png" />
    
    <script>
        const API_BASE = 'https://istanbulfashiontj.pythonanywhere.com';
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5FBF',
                        'primary-dark': '#6D28D9',
                        accent: '#F59E0B',
                        'accent-dark': '#D97706',
                        dark: '#0F172A',
                        light: '#F8FAFC',
                        surface: '#FFFFFF',
                        danger: '#EF4444'
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'glow': '0 0 20px rgba(139, 95, 191, 0.3)'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #8B5FBF; }

        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .product-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .action-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
        }
        .product-card:hover .action-overlay {
            opacity: 1;
        }

        @media (max-width: 640px) {
            .action-overlay {
                background: transparent;
                opacity: 1;
                align-items: flex-end;
                justify-content: flex-end;
                padding: 10px;
                pointer-events: none;
            }
            .action-btn-mobile {
                pointer-events: auto;
                background: white;
                color: #8B5FBF;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
        }

        .custom-checkbox:checked {
            background-color: #8B5FBF;
            border-color: #8B5FBF;
        }

        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #8B5FBF; cursor: pointer; margin-top: -6px; box-shadow: 0 0 0 3px white, 0 0 0 5px #8B5FBF;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E2E8F0; border-radius: 2px;
        }

        .filter-drawer {
            position: fixed; top: 0; left: -100%; width: 300px; height: 100%;
            background: white; z-index: 60; transition: left 0.3s ease-in-out;
            box-shadow: 10px 0 30px rgba(0,0,0,0.1); overflow-y: auto;
        }
        .filter-drawer.open { left: 0; }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; 
            z-index: 9999; 
            display: flex;
            justify-content: center; 
            align-items: center;
            transition: opacity 0.6s ease-out, visibility 0.6s ease-out;
        }

        .video-wrapper {
            width: 180px; 
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
            pointer-events: none;
        }

        #app-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        #app-notification.success { border-left: 4px solid #10B981; }
        #app-notification.error { border-left: 4px solid #EF4444; }

        .notif-icon-box {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .success .notif-icon-box { background: #D1FAE5; color: #10B981; }
        .error .notif-icon-box { background: #FEE2E2; color: #EF4444; }
    </style>
</head>
<body class="bg-light text-slate-800">

    <div id="preloader">
        <div class="video-wrapper">
            <video autoplay loop muted playsinline>
                <source src="https://istanbulfashiontj.pythonanywhere.com/static/uploads/logo.mp4" type="video/mp4">
                <img src="https://istanbulfashiontj.pythonanywhere.com/static/uploads/logo.png" alt="Loading..." class="w-full h-full object-contain">
            </video>
        </div>
    </div>

    <div id="app-notification">
        <div class="notif-icon-box">
            <i class="fas fa-check"></i>
        </div>
        <div class="flex-1 min-w-0">
            <p class="text-sm font-bold text-slate-800" id="notif-title">Success</p>
            <p class="text-xs text-slate-500 truncate" id="notif-message">Message goes here</p>
        </div>
    </div>

    <header class="fixed w-full top-0 z-50 glass-nav transition-all duration-300">
        <div class="container mx-auto px-4 sm:px-6">
            <div class="flex justify-between items-center h-16 sm:h-20">
                <button id="mobile-menu-btn" class="lg:hidden text-2xl text-dark hover:text-primary transition">
                    <i class="fas fa-bars"></i>
                </button>

                <a href="index.html" class="flex items-center gap-2 group">
                    <img src="https://istanbulfashiontj.pythonanywhere.com/static/uploads/logo.png" alt="Istanbul Wear" class="h-9 w-9 sm:h-10 sm:w-10 object-contain group-hover:scale-110 transition-transform">
                    <div class="hidden sm:block">
                        <span class="font-bold text-lg tracking-tight">ISTANBUL<span class="text-primary">FASHION</span></span>
                    </div>
                </a>

                <nav class="hidden lg:flex items-center space-x-8">
                    <a href="index.html" class="text-sm font-semibold text-slate-600 hover:text-primary transition">Асосӣ</a>
                    <a href="magazin.html" class="text-sm font-bold text-primary">Мағоза</a>
                    <div class="relative group">
                        <button class="text-sm font-semibold text-slate-600 hover:text-primary transition flex items-center gap-1">
                            Категорияҳо <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div class="absolute top-full left-0 w-48 bg-white shadow-soft rounded-xl p-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all transform translate-y-2 group-hover:translate-y-0 duration-200">
                            <div id="desktop-categories-dropdown" class="flex flex-col">
                                <span class="text-xs text-slate-400 p-2">Боргирӣ...</span>
                            </div>
                        </div>
                    </div>
                    <a href="tamos.html" class="text-sm font-semibold text-slate-600 hover:text-primary transition">Тамос</a>
                </nav>

                <div class="flex items-center gap-3">
                    <button class="lg:hidden text-slate-600 hover:text-primary" onclick="document.getElementById('mobile-search-bar').classList.toggle('hidden')">
                        <i class="fas fa-search text-lg"></i>
                    </button>

                    <a href="wishlist.html" class="relative p-2 text-slate-600 hover:text-primary transition">
                        <i class="far fa-heart text-xl"></i>
                        <span id="wishlist-count" class="absolute top-0 right-0 h-4 w-4 bg-accent text-[10px] font-bold text-white rounded-full flex items-center justify-center scale-0 transition-transform duration-300">0</span>
                    </a>
                    
                    <a href="sabad.html" class="relative p-2 text-slate-600 hover:text-primary transition">
                        <i class="fas fa-shopping-bag text-xl"></i>
                        <span id="cart-count" class="absolute top-0 right-0 h-4 w-4 bg-primary text-[10px] font-bold text-white rounded-full flex items-center justify-center scale-0 transition-transform duration-300">0</span>
                    </a>

                    <div id="user-section" class="relative ml-1 hidden sm:block"></div>
                </div>
            </div>
            
            <div id="mobile-search-bar" class="hidden px-4 pb-4 lg:hidden">
                <input type="text" id="mobile-search-input" placeholder="Ҷустуҷӯ..." class="w-full bg-slate-100 border border-slate-200 rounded-xl px-4 py-2 outline-none focus:border-primary text-sm">
            </div>
        </div>
    </header>

    <div id="overlay" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm transition-opacity"></div>

    <div id="mobile-menu" class="fixed top-0 left-[-100%] w-[80%] max-w-sm h-full bg-white z-[60] shadow-2xl transition-all duration-300 p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <span class="font-bold text-xl">Меню</span>
            <button id="close-menu-btn" class="text-slate-500 hover:text-danger p-2"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <div id="mobile-user-card" class="bg-slate-50 rounded-2xl p-4 mb-6 flex items-center gap-3 border border-slate-100">
            <div class="w-10 h-10 rounded-full bg-slate-200 animate-pulse"></div>
            <div class="flex-1 space-y-2">
                <div class="h-4 bg-slate-200 rounded w-2/3 animate-pulse"></div>
            </div>
        </div>

        <div class="mb-6 relative">
            <input type="text" id="mobile-search-input-menu" placeholder="Ҷустуҷӯи маҳсулот..." class="w-full bg-slate-100 border-none rounded-xl py-3 px-4 pl-10 text-sm focus:ring-2 focus:ring-primary outline-none">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
        </div>

        <nav class="space-y-1">
            <a href="index.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition">
                <i class="fas fa-home w-5"></i> Асосӣ
            </a>
            <a href="magazin.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-primary/10 text-primary font-medium">
                <i class="fas fa-store w-5"></i> Мағоза
            </a>
            
            <div class="py-2">
                <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Категорияҳо</p>
                <div id="mobile-categories-list" class="space-y-1 pl-2">
                    
                </div>
            </div>

            <a href="tamos.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition">
                <i class="fas fa-headset w-5"></i> Тамос
            </a>
        </nav>
    </div>

    <div id="filter-drawer" class="filter-drawer p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-xl text-dark">Филтрҳо</h3>
            <button onclick="toggleFilters()" class="text-slate-500 hover:text-danger"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div id="mobile-filters-content">
            
        </div>
        <button onclick="toggleFilters()" class="w-full mt-6 py-3 bg-primary text-white font-bold rounded-xl shadow-lg">Натиҷа ( <span id="mobile-result-count">0</span> )</button>
    </div>

    <main class="pt-24 sm:pt-28 pb-12 container mx-auto px-4 sm:px-6 min-h-screen">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8" data-aos="fade-up">
            <div>
                <nav class="flex text-xs text-slate-500 mb-2">
                    <a href="index.html" class="hover:text-primary">Асосӣ</a>
                    <span class="mx-2">/</span>
                    <span class="text-slate-800 font-semibold">Мағоза</span>
                </nav>
                <h1 class="text-3xl font-extrabold text-dark">Ҳамаи Маҳсулот</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleFilters()" class="lg:hidden px-4 py-2 bg-white border border-slate-200 rounded-xl text-slate-700 font-semibold text-sm hover:border-primary hover:text-primary transition shadow-sm">
                    <i class="fas fa-filter mr-2"></i> Филтр
                </button>
                
                <div class="relative group">
                    <select id="sort-select" class="appearance-none bg-white border border-slate-200 pl-4 pr-10 py-2 rounded-xl text-sm font-semibold text-slate-700 focus:outline-none focus:border-primary cursor-pointer shadow-sm">
                        <option value="newest">Навтарин</option>
                        <option value="price_asc">Арзон ба Қиммат</option>
                        <option value="price_desc">Қиммат ба Арзон</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 relative">
            
            <aside class="w-full lg:w-64 flex-shrink-0 hidden lg:block" data-aos="fade-right">
                <div class="sticky top-24 space-y-8">
                    
                    <div class="relative">
                        <input type="text" id="desktop-search" placeholder="Ҷустуҷӯи маҳсулот..." class="w-full bg-white border border-slate-200 rounded-xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm">
                        <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>

                    <div>
                        <h3 class="font-bold text-dark mb-4">Категорияҳо</h3>
                        <div id="categories-list" class="space-y-2">
                            <div class="space-y-2">
                                <div class="h-6 bg-slate-200 rounded w-3/4 skeleton"></div>
                                <div class="h-6 bg-slate-200 rounded w-2/3 skeleton"></div>
                                <div class="h-6 bg-slate-200 rounded w-4/5 skeleton"></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-dark mb-4">Нарх</h3>
                        <input type="range" id="price-range" min="0" max="2000" step="10" value="2000" class="w-full mb-3">
                        <div class="flex justify-between text-sm font-semibold text-slate-600">
                            <span>0 с.</span>
                            <span id="price-value" class="text-primary">2000 с.</span>
                        </div>
                    </div>

                    <button onclick="resetFilters()" class="w-full py-2 text-sm font-bold text-slate-500 hover:text-danger transition border border-dashed border-slate-300 rounded-xl hover:border-danger hover:bg-red-50">
                        Тоза кардани филтрҳо
                    </button>
                </div>
            </aside>

            <div class="flex-1">
                <div id="active-filters" class="flex flex-wrap gap-2 mb-6 hidden">
                    
                </div>

                <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-3 gap-4 sm:gap-6">
                    <div class="bg-white rounded-2xl p-3 shadow-sm border border-slate-100">
                        <div class="aspect-[3/4] bg-slate-100 rounded-xl mb-3 skeleton"></div>
                        <div class="h-4 bg-slate-100 rounded w-3/4 mb-2 skeleton"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2 skeleton"></div>
                    </div>
                </div>

                <div id="empty-state" class="hidden text-center py-20">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400 text-3xl">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 class="text-xl font-bold text-dark mb-2">Маҳсулот ёфт нашуд</h3>
                    <p class="text-slate-500 mb-6">Лутфан филтрҳоро тағйир диҳед ё калимаи дигарро ҷустуҷӯ кунед.</p>
                    <button onclick="resetFilters()" class="px-6 py-2 bg-primary text-white font-bold rounded-xl shadow-lg">Ҳамаи маҳсулот</button>
                </div>
            </div>

        </div>
    </main>

    <footer class="bg-white border-t border-slate-200 pt-12 pb-6">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div class="col-span-1 md:col-span-1">
                    <a href="index.html" class="flex items-center gap-2 mb-4">
                        <img src="https://istanbulfashiontj.pythonanywhere.com/static/uploads/logo.png" alt="Logo" class="h-10 object-contain">
                        <span class="font-bold text-xl">ISTANBUL<span class="text-primary">FASHION</span></span>
                    </a>
                    <p class="text-slate-500 text-sm leading-relaxed mb-4">
                        Мо беҳтарин либосҳоро мустақиман аз Туркия, Узбакистон ба Тоҷикистон меорем. Сифати олӣ ва нархҳои дастрас.
                    </p>
                    <div class="flex gap-3">
                        <a href="https://www.instagram.com/istanbulfashion.tj/" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-primary hover:text-white transition"><i class="fab fa-instagram"></i></a>
                        <a href="https://chat.whatsapp.com/IvuY0dM9dTAICyOAFsXg9r?mode=hqrc" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-primary hover:text-white transition"><i class="fab fa-whatsapp"></i></a>
                        <a href="#" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-primary hover:text-white transition"><i class="fab fa-telegram-plane"></i></a>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-dark mb-4">Мағоза</h4>
                    <ul class="space-y-2 text-sm text-slate-500">
                        <li><a href="magazin.html" class="hover:text-primary transition">Мардона</a></li>
                        <li><a href="magazin.html" class="hover:text-primary transition">Занона</a></li>
                        <li><a href="magazin.html" class="hover:text-primary transition">Кӯдакона</a></li>
                        <li><a href="magazin.html" class="hover:text-primary transition">Навгониҳо</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-bold text-dark mb-4">Кӯмак</h4>
                    <ul class="space-y-2 text-sm text-slate-500">
                        <li><a href="tamos.html" class="hover:text-primary transition">Тамос бо мо</a></li>
                        <li><a href="tamos.html" class="hover:text-primary transition">Саволҳои зиёд такроршаванда</a></li>
                        <li><a href="tamos.html" class="hover:text-primary transition">Шартҳои хизматрасонӣ</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-bold text-dark mb-4">Тамос</h4>
                    <ul class="space-y-3 text-sm text-slate-500">
                        <li class="flex items-start gap-3">
                            <i class="fas fa-map-marker-alt text-primary mt-1"></i>
                            <span>ш.Душанбе, Б.Корвон, тарфаи Тилобозор, дарвозаи 4, қатори 3, аз тарафи дасти чап контейнер 3.</span>
                        </li>
                        <li class="flex items-center gap-3">
                            <i class="fas fa-phone-alt text-primary"></i>
                            <span>+992 81-639-99-99</span>
                        </li>
                        <li class="flex items-center gap-3">
                            <i class="fas fa-envelope text-primary"></i>
                            <span>info@istanbulwear.tj</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-slate-100 pt-6 text-center text-sm text-slate-400">
                <p>&copy; 2025 Istanbul Fashion Tj. Ҳамаи ҳуқуқҳо маҳфузанд.</p>
            </div>
        </div>
    </footer>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        AOS.init({ duration: 800, once: true });
        
        const state = {
            products: [],
            filteredProducts: [],
            categories: [],
            allProducts: [],
            filters: {
                category: 'all',
                maxPrice: 2000,
                search: '',
                sort: 'newest'
            },
            cart: JSON.parse(localStorage.getItem('cart') || '[]'),
            wishlist: JSON.parse(localStorage.getItem('wishlist') || '[]'),
            user: {
                token: localStorage.getItem('userToken'),
                name: localStorage.getItem('userName'),
                id: localStorage.getItem('userId')
            }
        };

        const els = {
            grid: document.getElementById('products-grid'),
            empty: document.getElementById('empty-state'),
            catList: document.getElementById('categories-list'),
            priceRange: document.getElementById('price-range'),
            priceValue: document.getElementById('price-value'),
            search: document.getElementById('desktop-search'),
            mobileSearch: document.getElementById('mobile-search-input'),
            mobileSearchMenu: document.getElementById('mobile-search-input-menu'),
            sort: document.getElementById('sort-select'),
            mobileFilters: document.getElementById('mobile-filters-content'),
            filterDrawer: document.getElementById('filter-drawer'),
            overlay: document.getElementById('overlay'),
            preloader: document.getElementById('preloader'),
            cartCount: document.getElementById('cart-count'),
            wishlistCount: document.getElementById('wishlist-count'),
            activeFilters: document.getElementById('active-filters'),
            userSection: document.getElementById('user-section'),
            mobileUserCard: document.getElementById('mobile-user-card'),
            mobileCategoriesList: document.getElementById('mobile-categories-list'),
            desktopCategoriesDropdown: document.getElementById('desktop-categories-dropdown'),
            mobileMenu: document.getElementById('mobile-menu'),
            mobileMenuBtn: document.getElementById('mobile-menu-btn'),
            closeMenuBtn: document.getElementById('close-menu-btn'),
            mobileSearchBar: document.getElementById('mobile-search-bar')
        };

        const getImageUrl = (path) => {
            if (!path) return '';
            if (path.startsWith('http') || path.startsWith('https')) return path;
            return `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
        };

        const showNotification = (message, type = 'success') => {
            const notif = document.getElementById('app-notification');
            const title = document.getElementById('notif-title');
            const msg = document.getElementById('notif-message');
            const iconBox = notif.querySelector('.notif-icon-box');
            const icon = iconBox.querySelector('i');
            
            notif.className = ''; 
            if (type === 'success') {
                notif.classList.add('success');
                title.innerText = 'Муваффақона!';
                icon.className = 'fas fa-check';
            } else {
                notif.classList.add('error');
                title.innerText = 'Огоҳӣ!';
                icon.className = 'fas fa-exclamation';
            }
            
            msg.innerText = message;
            notif.classList.add('show');
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        };

        const handleSearch = (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query) {
                    state.filters.search = query;
                    applyFilters();
                }
            }
        };

        const updateUserUI = () => {
            if (state.user.token) {
                els.userSection.innerHTML = `
                    <div class="relative group cursor-pointer ml-2">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-primary to-accent text-white flex items-center justify-center font-bold shadow-lg">
                            ${state.user.name ? state.user.name.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div class="absolute right-0 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0 w-48 z-50">
                            <div class="bg-white rounded-xl shadow-soft p-2 border border-slate-100">
                                <div class="px-3 py-2 border-b border-slate-100 mb-1">
                                    <p class="font-bold text-sm text-dark truncate">${state.user.name || 'Муштарӣ'}</p>
                                    <p class="text-xs text-slate-500">Муштарӣ</p>
                                </div>
                                <a href="account.html" class="block px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-primary rounded-lg transition"><i class="fas fa-user-circle mr-2"></i> Кабинет</a>
                                <button onclick="logout()" class="w-full text-left px-3 py-2 text-sm text-red-500 hover:bg-red-50 rounded-lg transition"><i class="fas fa-sign-out-alt mr-2"></i> Баромад</button>
                            </div>
                        </div>
                    </div>
                `;
                els.mobileUserCard.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-primary to-accent text-white flex items-center justify-center font-bold text-xl shadow-md">
                        ${state.user.name ? state.user.name.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-dark">${state.user.name || 'Муштарӣ'}</p>
                        <button onclick="logout()" class="text-xs text-red-500 font-medium hover:underline">Баромад кардан</button>
                    </div>
                    <a href="account.html" class="px-4 py-2 bg-primary text-white text-xs font-bold rounded-lg shadow-lg shadow-primary/30">Кабинет</a>
                `;
            } else {
                els.userSection.innerHTML = `<a href="sabtinom.html" class="ml-2 px-5 py-2 bg-dark text-white text-sm font-semibold rounded-full hover:bg-primary transition shadow-lg hover:shadow-primary/30">Воридшавӣ</a>`;
                els.mobileUserCard.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 text-xl">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-dark">Хуш омадед!</p>
                        <p class="text-xs text-slate-500">Барои харид ворид шавед</p>
                    </div>
                    <a href="sabtinom.html" class="px-4 py-2 bg-primary text-white text-xs font-bold rounded-lg shadow-lg shadow-primary/30">Ворид</a>
                `;
            }
        };

        window.logout = () => {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userName');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userId');
            window.location.reload();
        };

        const updateCounts = () => {
            els.cartCount.innerText = state.cart.reduce((a, b) => a + (b.quantity || 1), 0);
            
            const wishlistItems = JSON.parse(localStorage.getItem('wishlist') || '[]');
            els.wishlistCount.innerText = wishlistItems.length;
            
            els.cartCount.style.transform = state.cart.length > 0 ? 'scale(1)' : 'scale(0)';
            els.wishlistCount.style.transform = wishlistItems.length > 0 ? 'scale(1)' : 'scale(0)';
        };

        async function fetchData() {
            try {
                const [prodRes, catRes] = await Promise.all([
                    fetch(`${API_BASE}/api/products`),
                    fetch(`${API_BASE}/api/categories`)
                ]);
                
                state.products = await prodRes.json();
                state.allProducts = state.products;
                state.categories = await catRes.json();
                
                renderCategories();
                applyFilters(); 
                
                setTimeout(() => {
                    els.preloader.style.opacity = '0';
                    setTimeout(() => {
                        els.preloader.style.visibility = 'hidden';
                        els.preloader.style.display = 'none';
                    }, 500);
                }, 500);

            } catch (e) {
                console.error(e);
                els.grid.innerHTML = '<p class="text-center text-red-500 w-full col-span-3">Хатогӣ дар боргирии маҳсулот.</p>';
            }
        }

        function renderCategories() {
            const totalCount = state.allProducts.length;
            
            const html = `
                <label class="flex items-center justify-between cursor-pointer group p-2 rounded-lg hover:bg-slate-50 transition">
                    <div class="flex items-center">
                        <input type="radio" name="category" value="all" class="custom-checkbox w-4 h-4 rounded-full border-slate-300 text-primary focus:ring-primary" 
                            ${state.filters.category === 'all' ? 'checked' : ''} onchange="filterCategory('all')">
                        <span class="ml-3 text-sm font-medium text-slate-700 group-hover:text-primary">Ҳамааш</span>
                    </div>
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">${totalCount}</span>
                </label>
            ` + state.categories.map(cat => {
                const count = state.allProducts.filter(p => p.category === cat.name_tj).length;
                return `
                <label class="flex items-center justify-between cursor-pointer group p-2 rounded-lg hover:bg-slate-50 transition">
                    <div class="flex items-center">
                        <input type="radio" name="category" value="${cat.name_tj}" class="custom-checkbox w-4 h-4 rounded-full border-slate-300 text-primary focus:ring-primary"
                            ${state.filters.category === cat.name_tj ? 'checked' : ''} onchange="filterCategory('${cat.name_tj}')">
                        <span class="ml-3 text-sm font-medium text-slate-700 group-hover:text-primary">${cat.name_tj}</span>
                    </div>
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">${count}</span>
                </label>`;
            }).join('');

            if (els.catList) els.catList.innerHTML = html;
            
            if (els.mobileCategoriesList) {
                els.mobileCategoriesList.innerHTML = state.categories.map(cat => `
                    <a href="magazin.html?category=${cat.name_tj}" class="block px-4 py-2 text-slate-500 hover:text-primary transition flex items-center justify-between">
                        ${cat.name_tj} <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-400">${state.allProducts.filter(p => p.category === cat.name_tj).length || 0}</span>
                    </a>
                `).join('');
            }

            if (els.desktopCategoriesDropdown) {
                els.desktopCategoriesDropdown.innerHTML = state.categories.map(cat => `
                    <a href="magazin.html?category=${cat.name_tj}" class="block px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-primary rounded-lg transition">
                        ${cat.name_tj}
                    </a>
                `).join('');
            }

            if (els.mobileFilters) {
                els.mobileFilters.innerHTML = `
                    <div class="mb-6">
                        <h4 class="font-bold text-dark mb-3">Категорияҳо</h4>
                        <div class="space-y-1">${html}</div>
                    </div>
                    <div class="mb-6">
                        <h4 class="font-bold text-dark mb-3">Нарх: <span id="mobile-price-val" class="text-primary">${state.filters.maxPrice} с.</span></h4>
                        <input type="range" min="0" max="2000" step="10" value="${state.filters.maxPrice}" 
                            class="w-full" oninput="updateMobilePrice(this.value)" onchange="updatePrice(this.value)">
                    </div>
                `;
            }
        }

        function renderProducts() {
            const list = state.filteredProducts;
            if (document.getElementById('mobile-result-count')) {
                document.getElementById('mobile-result-count').innerText = list.length;
            }
            
            if (list.length === 0) {
                els.grid.innerHTML = '';
                els.grid.classList.add('hidden');
                els.empty.classList.remove('hidden');
                return;
            }

            els.grid.classList.remove('hidden');
            els.empty.classList.add('hidden');

            els.grid.innerHTML = list.map((p, idx) => {
                const price = p.price;
                const oldPrice = p.old_price ? `<span class="text-xs text-slate-400 line-through mr-2">${p.old_price} с.</span>` : '';
                const discount = p.old_price ? Math.round(((p.old_price - p.price) / p.old_price) * 100) : 0;
                const badge = discount > 0 ? `<div class="absolute top-3 left-3 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-md z-20">-${discount}%</div>` : '';
                
                const wishlistItems = JSON.parse(localStorage.getItem('wishlist') || '[]');
                const isInWishlist = wishlistItems.some(item => {
                    if (typeof item === 'object') {
                        return item.id === p.id;
                    }
                    return parseInt(item) === parseInt(p.id);
                });
                const heartClass = isInWishlist ? 'fas text-red-500' : 'far';

                return `
                <div class="product-card bg-white rounded-2xl p-3 shadow-soft border border-slate-50 group relative" data-aos="fade-up" data-aos-delay="${idx * 50}">
                    <div class="product-image-container relative aspect-[3/4] bg-slate-100 rounded-xl overflow-hidden mb-3">
                        <a href="mahsolot.html?id=${p.id}" class="block w-full h-full">
                            <img src="${getImageUrl(p.image_url || p.image)}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy" 
                                onerror="this.src='https://placehold.co/400x600/f1f5f9/94a3b8?text=No+Image'">
                        </a>
                        ${badge}
                        
                        <button onclick="toggleWishlist(${p.id}, this)" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-white/80 backdrop-blur flex items-center justify-center shadow-sm hover:bg-white hover:text-danger transition z-30 ${isInWishlist ? 'text-danger' : 'text-slate-500'}">
                            <i class="${heartClass} fa-heart"></i>
                        </button>
                        
                        <div class="action-overlay">
                            <a href="mahsolot.html?id=${p.id}" class="hidden sm:flex px-5 py-2.5 bg-white text-primary text-sm font-bold rounded-full shadow-lg hover:bg-primary hover:text-white transition items-center gap-2 transform active:scale-95 hover:scale-105">
                                <i class="fas fa-eye"></i> Муфассал
                            </a>
                            <a href="mahsolot.html?id=${p.id}" class="action-btn-mobile sm:hidden w-8 h-8 bg-white/90 rounded-full flex items-center justify-center">
                                <i class="fas fa-eye text-primary text-sm"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="px-1">
                        <p class="text-xs text-slate-400 mb-1 truncate">${p.category || 'Умумӣ'}</p>
                        <a href="mahsolot.html?id=${p.id}" class="block font-bold text-dark text-sm mb-2 truncate hover:text-primary transition">${p.name_tj}</a>
                        <div class="flex items-center gap-2">
                            <span class="text-primary font-bold text-base">${price} с.</span>
                            ${oldPrice}
                        </div>
                            <a href="mahsolot.html?id=${p.id}" class="mt-2 w-full flex items-center justify-center gap-2 bg-primary/10 text-primary font-semibold py-2 text-sm rounded-lg hover:bg-primary hover:text-white transition transform active:scale-95">
                                <i class="fas fa-shopping-bag text-xs"></i> Ба сабад
                            </a>
                    </div>
                </div>`;
            }).join('');
        }

        function applyFilters() {
            let res = [...state.allProducts];

            if (state.filters.category !== 'all') {
                res = res.filter(p => p.category === state.filters.category);
            }

            res = res.filter(p => p.price <= state.filters.maxPrice);

            if (state.filters.search) {
                const term = state.filters.search.toLowerCase();
                res = res.filter(p => 
                    p.name_tj.toLowerCase().includes(term) || 
                    (p.description_tj && p.description_tj.toLowerCase().includes(term))
                );
            }

            if (state.filters.sort === 'newest') {
                res.sort((a, b) => b.id - a.id);
            } else if (state.filters.sort === 'price_asc') {
                res.sort((a, b) => a.price - b.price);
            } else if (state.filters.sort === 'price_desc') {
                res.sort((a, b) => b.price - a.price);
            }

            state.filteredProducts = res;
            renderProducts();
            updateActiveTags();
        }

        window.filterCategory = (cat) => {
            state.filters.category = cat;
            applyFilters();
            document.querySelectorAll(`input[name="category"][value="${cat}"]`).forEach(el => el.checked = true);
        };

        window.updatePrice = (val) => {
            state.filters.maxPrice = Number(val);
            if (els.priceValue) els.priceValue.innerText = val + ' с.';
            const mobilePriceVal = document.getElementById('mobile-price-val');
            if (mobilePriceVal) mobilePriceVal.innerText = val + ' с.';
            applyFilters();
        };
        
        window.updateMobilePrice = (val) => {
             const mobilePriceVal = document.getElementById('mobile-price-val');
             if (mobilePriceVal) mobilePriceVal.innerText = val + ' с.';
        }

        window.resetFilters = () => {
            state.filters = { category: 'all', maxPrice: 2000, search: '', sort: 'newest' };
            if (els.priceRange) els.priceRange.value = 2000;
            if (els.priceValue) els.priceValue.innerText = '2000 с.';
            if (els.search) els.search.value = '';
            if (els.mobileSearch) els.mobileSearch.value = '';
            if (els.mobileSearchMenu) els.mobileSearchMenu.value = '';
            if (els.sort) els.sort.value = 'newest';
            document.querySelectorAll('input[name="category"][value="all"]').forEach(el => el.checked = true);
            applyFilters();
        };

        if (els.search) els.search.addEventListener('input', (e) => {
            state.filters.search = e.target.value;
            applyFilters();
        });
        if (els.mobileSearch) els.mobileSearch.addEventListener('input', (e) => {
            state.filters.search = e.target.value;
            applyFilters();
        });
        if (els.mobileSearchMenu) els.mobileSearchMenu.addEventListener('keydown', handleSearch);

        if (els.sort) els.sort.addEventListener('change', (e) => {
            state.filters.sort = e.target.value;
            applyFilters();
        });

        window.toggleFilters = () => {
            els.filterDrawer.classList.toggle('open');
            els.overlay.classList.toggle('hidden');
            if(els.filterDrawer.classList.contains('open')) {
                 document.body.style.overflow = 'hidden';
            } else {
                 document.body.style.overflow = '';
            }
        };
        
        window.toggleMenu = () => {
            const isOpen = els.mobileMenu.style.left === '0px';
            
            if(isOpen) {
                els.mobileMenu.style.left = '-100%';
                els.overlay.classList.add('hidden');
                document.body.style.overflow = '';
            } else {
                els.mobileMenu.style.left = '0';
                els.overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        };
        
        if (els.mobileMenuBtn) els.mobileMenuBtn.addEventListener('click', toggleMenu);
        if (els.closeMenuBtn) els.closeMenuBtn.addEventListener('click', toggleMenu);
        if (els.overlay) els.overlay.addEventListener('click', () => {
            if (els.filterDrawer.classList.contains('open')) {
                toggleFilters();
            } else {
                toggleMenu();
            }
        });

        function updateActiveTags() {
            const tags = [];
            if(state.filters.category !== 'all') tags.push({ text: state.filters.category, type: 'cat' });
            if(state.filters.maxPrice < 2000) tags.push({ text: `< ${state.filters.maxPrice} с.`, type: 'price' });
            if(state.filters.search) tags.push({ text: `"${state.filters.search}"`, type: 'search' });

            if(tags.length > 0 && els.activeFilters) {
                els.activeFilters.classList.remove('hidden');
                els.activeFilters.innerHTML = tags.map(t => `
                    <span class="text-xs font-bold px-3 py-1 bg-primary/10 text-primary rounded-full flex items-center gap-2">
                        ${t.text} <button onclick="removeFilter('${t.type}')" class="hover:text-danger"><i class="fas fa-times"></i></button>
                    </span>
                `).join('') + `<button onclick="resetFilters()" class="text-xs text-slate-500 underline">Тоза кардан</button>`;
            } else if (els.activeFilters) {
                els.activeFilters.classList.add('hidden');
            }
        }

        window.removeFilter = (type) => {
            if(type === 'cat') filterCategory('all');
            if(type === 'price') { 
                state.filters.maxPrice = 2000; 
                if (els.priceRange) els.priceRange.value = 2000; 
                if (els.priceValue) els.priceValue.innerText = '2000 с.'; 
                applyFilters(); 
            }
            if(type === 'search') { 
                state.filters.search = ''; 
                if (els.search) els.search.value = ''; 
                if (els.mobileSearch) els.mobileSearch.value = ''; 
                if (els.mobileSearchMenu) els.mobileSearchMenu.value = ''; 
                applyFilters(); 
            }
        };

        window.addToCart = (productId) => {
            const product = state.allProducts.find(p => p.id === productId);
            if (!product) return;

            const existingItem = state.cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 1) + 1;
                showNotification(`Миқдори "${product.name_tj}" зиёд карда шуд.`, 'success');
            } else {
                state.cart.push({
                    id: product.id,
                    name_tj: product.name_tj,
                    price: product.price,
                    image_url: product.image_url || product.image,
                    quantity: 1
                });
                showNotification(`"${product.name_tj}" ба сабад илова шуд!`, 'success');
            }

            localStorage.setItem('cart', JSON.stringify(state.cart));
            updateCounts();
        };

        window.toggleWishlist = async (productId, buttonElement) => {
            const product = state.allProducts.find(p => p.id === productId);
            if (!product) return;

            let wishlistItems = JSON.parse(localStorage.getItem('wishlist') || '[]');
            const isInWishlist = wishlistItems.some(item => {
                if (typeof item === 'object') {
                    return item.id === productId;
                }
                return parseInt(item) === parseInt(productId);
            });

            if (isInWishlist) {
                wishlistItems = wishlistItems.filter(item => {
                    if (typeof item === 'object') {
                        return item.id !== productId;
                    }
                    return parseInt(item) !== parseInt(productId);
                });
                
                if (state.user.token) {
                    try {
                        await fetch(`${API_BASE}/api/wishlist/${productId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${state.user.token}`
                            }
                        });
                    } catch (error) {
                        console.error('Error removing from server wishlist:', error);
                    }
                }
                
                buttonElement.querySelector('i').className = 'far fa-heart';
                buttonElement.classList.remove('text-danger');
                buttonElement.classList.add('text-slate-500');
                showNotification('Аз рӯйхати орзуҳо хориҷ карда шуд.', 'error');
            } else {
                const itemToAdd = {
                    id: product.id,
                    name_tj: product.name_tj,
                    price: product.price,
                    image_url: product.image_url || product.image,
                    category: product.category
                };
                
                wishlistItems.push(itemToAdd);
                
                if (state.user.token) {
                    try {
                        await fetch(`${API_BASE}/api/wishlist/${productId}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${state.user.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                    } catch (error) {
                        console.error('Error adding to server wishlist:', error);
                    }
                }
                
                buttonElement.querySelector('i').className = 'fas text-red-500 fa-heart';
                buttonElement.classList.remove('text-slate-500');
                buttonElement.classList.add('text-danger');
                showNotification('Ба рӯйхати орзуҳо илова шуд!', 'success');
            }

            localStorage.setItem('wishlist', JSON.stringify(wishlistItems));
            state.wishlist = wishlistItems;
            updateCounts();
        };

        const urlParams = new URLSearchParams(window.location.search);
        const urlCat = urlParams.get('category');
        const urlQ = urlParams.get('q');
        if(urlCat) state.filters.category = urlCat;
        if(urlQ) {
            state.filters.search = urlQ;
            if(els.search) els.search.value = urlQ;
            if(els.mobileSearch) els.mobileSearch.value = urlQ;
            if(els.mobileSearchMenu) els.mobileSearchMenu.value = urlQ;
        }

        updateUserUI();
        updateCounts();
        fetchData();
    });
</script>
</body>
</html>
